<div class="tab-content">
    <form [formGroup]="settingsForm" novalidate class="flex-col">
        <mat-form-field subscriptSizing="dynamic">
            <mat-label>BLE Mode</mat-label>
            <mat-select
                name="bleMode"
                placeholder="Select heart rate monitor mode"
                formControlName="bleMode"
                required
            >
                @for (flag of BleServiceFlag | enumToArray; track $index) {
                    <mat-option [value]="flag.key">{{ BleServiceNames[flag.value] }}</mat-option>
                }
            </mat-select>
            @if (settingsFormErrors()?.bleMode) {
                <mat-error>
                    @if (settingsFormErrors()?.bleMode?.required) {
                        BLE mode is required
                    }
                </mat-error>
            }
        </mat-form-field>
        <mat-form-field subscriptSizing="dynamic">
            <mat-label>Heart Rate Monitor</mat-label>
            <mat-select
                name="heartRateMonitor"
                placeholder="Select heart rate monitor mode"
                formControlName="heartRateMonitor"
                required
            >
                <mat-option value="off">off</mat-option>
                <mat-option value="ble">ble</mat-option>
                <mat-option value="ant">ant</mat-option>
            </mat-select>
            @if (settingsFormErrors()?.heartRateMonitor) {
                <mat-error>
                    @if (settingsFormErrors()?.heartRateMonitor?.required) {
                        Heart rate monitor mode is required
                    }
                    @if (settingsFormErrors()?.heartRateMonitor?.pattern) {
                        Invalid value
                    }
                </mat-error>
            }
        </mat-form-field>
        <mat-form-field subscriptSizing="dynamic">
            <mat-label>Log Level</mat-label>
            <mat-select name="logLevel" placeholder="Select log level" formControlName="logLevel" required>
                @for (logLevel of LogLevel | enumToArray; track logLevel.value) {
                    <mat-option [value]="logLevel.key">{{ logLevel.value }}</mat-option>
                }
            </mat-select>
            @if (settingsFormErrors()?.logLevel) {
                <mat-error>
                    @if (settingsFormErrors()?.logLevel?.required) {
                        Log level is required
                    }
                    @if (settingsFormErrors()?.logLevel?.min || settingsFormErrors()?.logLevel?.max) {
                        Invalid value
                    }
                </mat-error>
            }
        </mat-form-field>
        <h4>Delta Time Logging</h4>
        <mat-checkbox formControlName="deltaTimeLogging">Bluetooth</mat-checkbox>
        <mat-checkbox formControlName="logToSdCard">SdCard</mat-checkbox>
    </form>
    <div class="erg-info flex-col">
        <span>Manufacturer: {{ deviceInfo().manufacturerName ?? "unknown" }} </span>
        @if (deviceInfo().modelNumber) {
            <span>Model: {{ deviceInfo().modelNumber }}</span>
        }
        @if (deviceInfo().hardwareRevision) {
            <span>Hardware: {{ deviceInfo().hardwareRevision }}</span>
        }
        <div versionInfo class="items-center">
            <span>FW Version: {{ deviceInfo().firmwareNumber ?? "unknown" }}</span>
            @if (isConnected()) {
                <button
                    matTooltipShowDelay="1000"
                    matTooltip="Upload firmware"
                    class="small-icon-button"
                    mat-icon-button
                    (click)="fileInput.click()"
                >
                    <mat-icon>upload_file</mat-icon>
                </button>
                <input
                    #fileInput
                    accept=".bin"
                    style="display: none"
                    type="file"
                    (change)="otaUpdate($event)"
                />
                @if (firmwareUpdateCheckerService.isUpdateAvailable() === true) {
                    <a
                        matTooltipShowDelay="1000"
                        matTooltip="Firmware update available - View on GitHub"
                        class="small-icon-button"
                        mat-icon-button
                        [href]="firmwareReleaseUrl"
                        target="_blank"
                        rel="noopener noreferrer"
                        aria-label="Open latest firmware release on GitHub"
                    >
                        <mat-icon>deployed_code_update</mat-icon>
                    </a>
                } @else {
                    <button
                        matTooltipShowDelay="1000"
                        matTooltip="{{
                            firmwareUpdateCheckerService.isUpdateAvailable() === undefined
                                ? 'Checking'
                                : 'Check'
                        }} for update"
                        class="small-icon-button"
                        mat-icon-button
                        (click)="firmwareUpdateCheckerService.checkForFirmwareUpdate()"
                    >
                        <mat-icon
                            [class.rotating]="
                                isConnected() &&
                                firmwareUpdateCheckerService.isUpdateAvailable() === undefined
                            "
                            >refresh</mat-icon
                        >
                    </button>
                }
            }
        </div>
    </div>
    <div versionInfo class="items-center">
        <span>GUI Version: {{ compileDate | date: "yyMMddHHmmss" }}</span>
        <button
            matTooltipShowDelay="1000"
            matTooltip="{{ isGuiUpdateInProgress() ? 'Checking' : 'Check' }} for update"
            class="small-icon-button"
            mat-icon-button
            (click)="checkForUpdates()"
        >
            <mat-icon [class.rotating]="isGuiUpdateInProgress()">refresh</mat-icon>
        </button>
    </div>
</div>
